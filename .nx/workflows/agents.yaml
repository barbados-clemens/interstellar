parallelism: 10
env:
  CI: 'true'
  NODE_OPTIONS: '--max_old_space_size=4096'
steps:
  - name: Git Clone
    script: |
      git init .
      git remote add origin $GIT_REPOSITORY_URL
      git fetch --no-tags --prune --progress --no-recurse-submodules --depth=1 origin +{{nxCommitSha}}:{{nxCommitRef}}
      git checkout --progress --force -B {{nxBranch}} {{nxCommitRef}}

  - name: Restore cache
    script: |
      nxw cache restore {{nxBranch}}-node_modules node_modules
      nxw cache restore {{nxBranch}}-cypress ~/.cache/Cypress

  - name: NPM install
    script: |
      npm ci

  - name: Run Agent
    script: |
      npx nx-cloud start-agent

  - name: Store to cache
    script: |
      nxw cache store {{nxBranch}}-node_modules node_modules
      nxw cache store {{nxBranch}}-cypress ~/.cache/Cypress
